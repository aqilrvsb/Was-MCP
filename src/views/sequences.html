<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequences - WhatsApp Multi-Device</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fab fa-whatsapp text-green-500 text-2xl mr-2"></i>
                    <span class="font-semibold text-xl">WhatsApp Analytics</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-700">{{ .User.Email }}</span>
                    <a href="/logout" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tab Navigation -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <nav class="flex space-x-8" aria-label="Tabs">
                <a href="/dashboard" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-chart-line mr-2"></i> Dashboard
                </a>
                <a href="/devices" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-mobile-alt mr-2"></i> Devices
                </a>
                <a href="/campaign" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-calendar-alt mr-2"></i> Campaign
                </a>
                <a href="/sequences" class="py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium">
                    <i class="fas fa-stream mr-2"></i> Sequences
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Message Sequences</h1>
            <p class="text-gray-600 mt-2">Create automated drip campaigns that send messages over multiple days</p>
        </div>

        <!-- Create New Sequence Button -->
        <div class="mb-6">
            <button onclick="showCreateModal()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-plus mr-2"></i> Create New Sequence
            </button>
        </div>

        <!-- Sequences Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="sequences-grid">
            <!-- Sequences will be loaded here -->
        </div>
    </div>

    <!-- Create Sequence Modal -->
    <div id="create-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="hideCreateModal()"></div>
            
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-2xl w-full z-20">
                <div class="bg-green-500 px-6 py-4">
                    <h3 class="text-lg font-medium text-white">Create New Sequence</h3>
                </div>
                
                <form id="create-sequence-form" class="p-6">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Sequence Name</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                        <textarea name="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Device</label>
                        <select name="device_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Select a device</option>
                            {{range .Devices}}
                            <option value="{{.ID}}">{{.DeviceName}} - {{.Phone}}</option>
                            {{end}}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Niche (Auto-enroll matching leads)</label>
                        <input type="text" name="niche" placeholder="e.g., real-estate, fitness, crypto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-700 text-sm font-bold">Sequence Steps</label>
                            <button type="button" onclick="addStep()" class="text-green-500 hover:text-green-700">
                                <i class="fas fa-plus"></i> Add Step
                            </button>
                        </div>
                        <div id="steps-container">
                            <!-- Steps will be added here -->
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="hideCreateModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                            Cancel
                        </button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                            Create Sequence
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Load sequences on page load
        document.addEventListener('DOMContentLoaded', loadSequences);
        
        async function loadSequences() {
            try {
                const response = await fetch('/api/sequences');
                const data = await response.json();
                
                if (data.code === 'SUCCESS' && data.results) {
                    displaySequences(data.results);
                }
            } catch (error) {
                console.error('Error loading sequences:', error);
            }
        }
        
        function displaySequences(sequences) {
            const grid = document.getElementById('sequences-grid');
            grid.innerHTML = '';
            
            if (sequences.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-stream text-gray-400 text-6xl mb-4"></i>
                        <p class="text-gray-500">No sequences created yet</p>
                    </div>
                `;
                return;
            }
            
            sequences.forEach(seq => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-semibold text-gray-900">${seq.name}</h3>
                        <span class="px-2 py-1 text-xs rounded-full ${seq.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${seq.is_active ? 'Active' : 'Paused'}
                        </span>
                    </div>
                    <p class="text-gray-600 mb-4">${seq.description || 'No description'}</p>
                    <div class="space-y-2 text-sm text-gray-500">
                        <div><i class="fas fa-bullseye mr-2"></i>Niche: ${seq.niche || 'All'}</div>
                        <div><i class="fas fa-calendar-day mr-2"></i>${seq.total_days} days</div>
                        <div><i class="fas fa-users mr-2"></i>${seq.contact_count || 0} contacts</div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <a href="/sequences/${seq.id}" class="text-blue-500 hover:text-blue-700">
                            <i class="fas fa-eye"></i> View
                        </a>
                        ${seq.is_active ? 
                            `<button onclick="pauseSequence('${seq.id}')" class="text-yellow-500 hover:text-yellow-700">
                                <i class="fas fa-pause"></i> Pause
                            </button>` :
                            `<button onclick="startSequence('${seq.id}')" class="text-green-500 hover:text-green-700">
                                <i class="fas fa-play"></i> Start
                            </button>`
                        }
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        let stepCount = 0;
        
        function showCreateModal() {
            document.getElementById('create-modal').classList.remove('hidden');
            // Add first step by default
            if (stepCount === 0) {
                addStep();
            }
        }
        
        function hideCreateModal() {
            document.getElementById('create-modal').classList.add('hidden');
            document.getElementById('create-sequence-form').reset();
            document.getElementById('steps-container').innerHTML = '';
            stepCount = 0;
        }
        
        function addStep() {
            stepCount++;
            const container = document.getElementById('steps-container');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'border rounded-lg p-4 mb-4';
            stepDiv.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold">Day ${stepCount}</h4>
                    <button type="button" onclick="removeStep(this)" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Message Type</label>
                        <select name="steps[${stepCount}][message_type]" onchange="toggleMediaField(this, ${stepCount})" required class="w-full px-2 py-1 border rounded">
                            <option value="text">Text</option>
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                            <option value="document">Document</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Send Time</label>
                        <input type="time" name="steps[${stepCount}][send_time]" value="10:00" required class="w-full px-2 py-1 border rounded">
                    </div>
                </div>
                <div class="mt-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Message Content</label>
                    <textarea name="steps[${stepCount}][content]" rows="3" required class="w-full px-2 py-1 border rounded" 
                        placeholder="Hi {{name}}, welcome to our sequence..."></textarea>
                </div>
                <div id="media-fields-${stepCount}" class="hidden mt-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Media URL</label>
                    <input type="url" name="steps[${stepCount}][media_url]" class="w-full px-2 py-1 border rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-1 mt-2">Caption (optional)</label>
                    <input type="text" name="steps[${stepCount}][caption]" class="w-full px-2 py-1 border rounded">
                </div>
                <input type="hidden" name="steps[${stepCount}][day]" value="${stepCount}">
            `;
            container.appendChild(stepDiv);
        }
        
        function removeStep(button) {
            button.closest('.border').remove();
            // Renumber remaining steps
            const steps = document.querySelectorAll('#steps-container > div');
            steps.forEach((step, index) => {
                const dayNum = index + 1;
                step.querySelector('h4').textContent = `Day ${dayNum}`;
                // Update input names
                step.querySelectorAll('input, select, textarea').forEach(input => {
                    const name = input.name;
                    if (name) {
                        input.name = name.replace(/steps\[\d+\]/, `steps[${dayNum}]`);
                    }
                });
            });
            stepCount = steps.length;
        }
        
        function toggleMediaField(select, stepNum) {
            const mediaFields = document.getElementById(`media-fields-${stepNum}`);
            if (select.value !== 'text') {
                mediaFields.classList.remove('hidden');
            } else {
                mediaFields.classList.add('hidden');
            }
        }
        
        // Handle form submission
        document.getElementById('create-sequence-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                device_id: formData.get('device_id'),
                niche: formData.get('niche'),
                is_active: true,
                steps: []
            };
            
            // Collect steps
            for (let i = 1; i <= stepCount; i++) {
                const step = {
                    day: i,
                    message_type: formData.get(`steps[${i}][message_type]`),
                    content: formData.get(`steps[${i}][content]`),
                    media_url: formData.get(`steps[${i}][media_url]`) || '',
                    caption: formData.get(`steps[${i}][caption]`) || '',
                    send_time: formData.get(`steps[${i}][send_time]`)
                };
                data.steps.push(step);
            }
            
            try {
                const response = await fetch('/api/sequences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.code === 'SUCCESS') {
                    hideCreateModal();
                    loadSequences();
                    alert('Sequence created successfully!');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error creating sequence: ' + error.message);
            }
        });
        
        async function startSequence(id) {
            try {
                const response = await fetch(`/api/sequences/${id}/start`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.code === 'SUCCESS') {
                    loadSequences();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function pauseSequence(id) {
            try {
                const response = await fetch(`/api/sequences/${id}/pause`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.code === 'SUCCESS') {
                    loadSequences();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>